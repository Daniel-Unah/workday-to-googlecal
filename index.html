<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workday to Google Calendar Converter</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Workday to Google Calendar Converter</h1>
        <p class="subtitle">Convert your Workday schedule to Google Calendar in seconds</p>

        <!-- Features -->
        <div class="features">
            <div class="feature">
                <div class="feature-icon">ðŸ“¤</div>
                <h3>Easy Upload</h3>
                <p>Just drag and drop your Excel file</p>
            </div>
            <div class="feature">
                <div class="feature-icon">âš¡</div>
                <h3>Instant Conversion</h3>
                <p>Processes files entirely in your browser</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ðŸ“…</div>
                <h3>Ready to Import</h3>
                <p>Download ICS file for any calendar app</p>
            </div>
        </div>

        <!-- Step 1: Instructions -->
        <div class="card">
            <h2><span class="step-number">1</span>Export from Workday</h2>
            <div class="instructions">
                <p><strong>How to get your schedule from Workday:</strong></p>
                <ol>
                    <li>Log into your Workday account</li>
                    <li>Navigate to your course schedule or academic calendar</li>
                    <li>Look for the "Export to Excel" button</li>
                    <li>Click download when prompted</li>
                </ol>
                
                <div style="margin: 20px 0; text-align: center;">
                    <img src="export_to_excel.jpg" alt="Workday Export Button Location" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" />
                    <p style="margin-top: 10px; font-style: italic; color: #666;">Look for the Export button in your Workday schedule view</p>
                </div>
                
                <p><strong>Note:</strong> The Excel file should contain columns like Course Name, Days, Time, Location, etc.</p>
            </div>
        </div>

        <!-- Step 2: File Upload -->
        <div class="card">
            <h2><span class="step-number">2</span>Upload Your Excel File</h2>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx" class="file-input" />
            </div>
            <div id="errorMessage" class="error hidden"></div>
            <div id="successMessage" class="success hidden"></div>
            <div id="preview"></div>
        </div>

        <!-- Step 3: Download -->
                  <div class="card">
            <h2><span class="step-number">3</span>Add to Your Calendar</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; flex-direction: column; align-items: center;">
              <button id="downloadBtn" class="btn" disabled>Download ICS File</button>
              <button id="resetBtn" class="btn btn-secondary" onclick="resetConverter()">Upload New File</button>
            </div>
            <p style="margin-top: 15px; color: #666;">
              <strong>ICS File:</strong> Import the downloaded .ics file into Google Calendar, Outlook, Apple Calendar, or any calendar application.<br>
              <strong>Google Calendar:</strong> Use the individual "Add to Google Calendar" buttons in the table above to add each course to your calendar.
            </p>
          </div>

        <div class="footer">
            <p>Built for students â€¢ No data is stored or sent to servers â€¢ Everything processes locally in your browser</p>
        </div>
    </div>

    <script>
        let courses = [];
        let currentTimezone = 'America/Chicago';

        // File input handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                hideMessages();
                parseExcelFile(file);
            }
        });

        // Download button handling
        document.getElementById('downloadBtn').addEventListener('click', function() {
            downloadICS(courses);
        });


        function parseExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    console.log('Worksheet object:', worksheet);
                    console.log('Worksheet range:', worksheet['!ref']);
                    
                    // Try multiple parsing methods
                    let jsonData = [];
                    
                    // Method 1: Standard parsing
                    jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: '', raw: false});
                    console.log('Method 1 - Standard parsing:', jsonData);
                    console.log('Method 1 - Number of rows:', jsonData.length);
                    
                    // Method 2: If we get empty or single row, try different options
                    if (jsonData.length < 2) {
                        console.log('Trying Method 2 - Raw parsing...');
                        jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: '', raw: true});
                        console.log('Method 2 result:', jsonData);
                        console.log('Method 2 - Number of rows:', jsonData.length);
                    }
                    
                    // Method 3: Try parsing as CSV
                    if (jsonData.length < 2) {
                        console.log('Trying Method 3 - CSV parsing...');
                        const csv = XLSX.utils.sheet_to_csv(worksheet);
                        console.log('CSV data:', csv);
                        jsonData = csv.split('\n').map(row => row.split(','));
                        console.log('Method 3 result:', jsonData);
                        console.log('Method 3 - Number of rows:', jsonData.length);
                    }
                    
                    // Method 4: Try parsing with expanded range
                    if (jsonData.length < 2) {
                        console.log('Trying Method 4 - Expanded range parsing...');
                        
                        // Find the actual range by looking at all cells
                        let maxRow = 0;
                        let maxCol = 0;
                        
                        Object.keys(worksheet).forEach(key => {
                            if (key.startsWith('!')) return; // Skip metadata
                            const cellRef = XLSX.utils.decode_cell(key);
                            maxRow = Math.max(maxRow, cellRef.r);
                            maxCol = Math.max(maxCol, cellRef.c);
                        });
                        
                        console.log('Detected max row:', maxRow, 'max col:', maxCol);
                        
                        // Create expanded range
                        const range = {s: {r: 0, c: 0}, e: {r: maxRow, c: maxCol}};
                        console.log('Expanded range:', range);
                        
                        jsonData = [];
                        for (let R = range.s.r; R <= range.e.r; ++R) {
                            const row = [];
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                const cell = worksheet[cellAddress];
                                row.push(cell ? cell.v : '');
                            }
                            jsonData.push(row);
                        }
                        console.log('Method 4 result:', jsonData);
                        console.log('Method 4 - Number of rows:', jsonData.length);
                    }
                    
                    courses = parseWorkdayData(jsonData);
                    
                    console.log('Final parsed courses:', courses);
                    
                    if (courses.length === 0) {
                        showError('No courses found. The Excel file might be in an unsupported format. Please try saving it as a different Excel format (.xlsx) or check the browser console for debugging info.');
                        return;
                    }
                    
                    displayPreview(courses);
                    document.getElementById('downloadBtn').disabled = false;
                    showSuccess(`Successfully parsed ${courses.length} courses!`);
                    
                } catch (error) {
                    console.error('Error parsing Excel:', error);
                    showError('Error reading Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseWorkdayData(data) {
            if (data.length < 2) {
                console.log('Not enough data rows:', data.length);
                return [];
            }
            
            console.log('Raw Excel data:', data);
            
            // Find header row (look for common column names)
            let headerRow = 0;
            
            // Try to find the right row with headers
            for (let i = 0; i < Math.min(5, data.length); i++) {
                const row = data[i] || [];
                console.log(`Checking row ${i}:`, row);
                if (row.some(cell => 
                    cell && typeof cell === 'string' && 
                    (cell.toLowerCase().includes('meeting patterns') || 
                     cell.toLowerCase().includes('instructor') ||
                     cell.toLowerCase().includes('start date') ||
                     cell.toLowerCase().includes('course listing'))
                )) {
                    headerRow = i;
                    console.log('Found header row at index:', headerRow);
                    break;
                }
            }
            
            const headers = data[headerRow] || [];
            console.log('Using headers:', headers);
            const courses = [];
            
            // Map Workday-specific column names
            const columnMap = {
                courseListing: findColumn(headers, ['course listing', 'course', 'subject', 'class', 'name', 'title']),
                meetingPatterns: findColumn(headers, ['meeting patterns', 'enrolled sections meeting patterns', 'schedule', 'days', 'time']),
                instructor: findColumn(headers, ['instructor', 'professor', 'teacher', 'staff']),
                startDate: findColumn(headers, ['start date', 'start']),
                endDate: findColumn(headers, ['end date', 'end'])
            };
            
            console.log('Column mapping:', columnMap);
            
            // Parse each row
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i] || [];
                if (row.every(cell => !cell)) continue; // Skip empty rows
                
                console.log(`Processing row ${i}:`, row);
                
                // Extract course name from Course Listing column
                const courseListing = getCellValue(row, columnMap.courseListing) || '';
                const courseName = extractCourseName(courseListing);
                
                // Extract meeting info from Meeting Patterns column
                const meetingPatterns = getCellValue(row, columnMap.meetingPatterns) || '';
                const meetingInfo = parseMeetingPatterns(meetingPatterns);
                
                const course = {
                    id: courses.length + 1,
                    title: courseName || 'Untitled Event',
                    days: meetingInfo.days || 'Monday',
                    time: meetingInfo.startTime || '09:00',
                    endTime: meetingInfo.endTime || '10:00',
                    location: meetingInfo.location || '',
                    instructor: getCellValue(row, columnMap.instructor) || ''
                };
                
                console.log(`Row ${i} -> Course:`, course);
                
                // Only add if we have a meaningful title
                if (course.title && course.title !== 'Untitled Event' && course.title.length > 2) {
                    courses.push(course);
                }
            }
            
            return courses;
        }
        
        function extractCourseName(courseListing) {
            // Extract course name from strings like "CSE 4501 - Video Game Programming II"
            const match = courseListing.match(/([A-Z]{2,4}\s+\d{4})\s*-\s*(.+?)(?:\s*-\s*Fall|$)/);
            if (match) {
                return `${match[1]} - ${match[2]}`;
            }
            return courseListing;
        }
        
        function parseMeetingPatterns(meetingPatterns) {
            console.log('Parsing meeting patterns:', meetingPatterns);
            
            // Parse strings like "Mon/Wed | 5:30 PM - 7:00 PM | RIDGLEY, Room 00016"
            const parts = meetingPatterns.split('|').map(p => p.trim());
            console.log('Split parts:', parts);
            
            let days = 'Monday';
            let startTime = '09:00';
            let endTime = '10:00';
            let location = '';
            
            if (parts.length >= 1) {
                // Parse days
                const dayStr = parts[0];
                console.log('Parsing days from:', dayStr);
                
                // Handle multiple days like "Mon/Wed"
                if (dayStr.includes('/')) {
                    const dayParts = dayStr.split('/');
                    const dayNames = [];
                    dayParts.forEach(part => {
                        if (part.includes('Mon')) dayNames.push('Monday');
                        if (part.includes('Tue')) dayNames.push('Tuesday');
                        if (part.includes('Wed')) dayNames.push('Wednesday');
                        if (part.includes('Thu')) dayNames.push('Thursday');
                        if (part.includes('Fri')) dayNames.push('Friday');
                        if (part.includes('Sat')) dayNames.push('Saturday');
                        if (part.includes('Sun')) dayNames.push('Sunday');
                    });
                    days = dayNames.join('/');
                } else {
                    // Single day
                    if (dayStr.includes('Mon')) days = 'Monday';
                    if (dayStr.includes('Tue')) days = 'Tuesday';
                    if (dayStr.includes('Wed')) days = 'Wednesday';
                    if (dayStr.includes('Thu')) days = 'Thursday';
                    if (dayStr.includes('Fri')) days = 'Friday';
                    if (dayStr.includes('Sat')) days = 'Saturday';
                    if (dayStr.includes('Sun')) days = 'Sunday';
                }
                console.log('Parsed days:', days);
            }
            
            if (parts.length >= 2) {
                // Parse time
                const timeStr = parts[1];
                console.log('Parsing time from:', timeStr);
                const timeMatch = timeStr.match(/(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/);
                if (timeMatch) {
                    startTime = timeMatch[1];
                    endTime = timeMatch[2];
                    console.log('Parsed times:', startTime, 'to', endTime);
                } else {
                    console.log('No time match found');
                }
            }
            
            if (parts.length >= 3) {
                // Parse location
                location = parts[2];
                console.log('Parsed location:', location);
            }
            
            const result = { days, startTime, endTime, location };
            console.log('Final meeting info:', result);
            return result;
        }

        function findColumn(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toLowerCase();
                if (keywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            return -1;
        }

        function getCellValue(row, columnIndex) {
            if (columnIndex === -1 || !row[columnIndex]) return '';
            return row[columnIndex].toString().trim();
        }

        function displayPreview(courses) {
            const preview = document.getElementById('preview');
            
            let html = `
                <h3 style="margin: 20px 0 15px 0; color: #4a5568;">Found ${courses.length} courses:</h3>
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Days</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Instructor</th>
                            <th>Add to Calendar</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            courses.forEach((course, index) => {
                html += `
                    <tr>
                        <td><strong>${course.title}</strong></td>
                        <td>${course.days}</td>
                        <td>${course.time} - ${course.endTime}</td>
                        <td>${course.location}</td>
                        <td>${course.instructor}</td>
                        <td>
                            <button class="google-calendar-btn" 
                                    data-title="${course.title.replace(/"/g, '&quot;')}"
                                    data-days="${course.days.replace(/"/g, '&quot;')}"
                                    data-time="${course.time.replace(/"/g, '&quot;')}"
                                    data-end-time="${course.endTime.replace(/"/g, '&quot;')}"
                                    data-location="${course.location.replace(/"/g, '&quot;')}"
                                    data-instructor="${course.instructor.replace(/"/g, '&quot;')}"
                                    style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%; max-width: 150px;">
                                Add to Google Calendar
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            preview.innerHTML = html;
            
            // Add event listeners to the Google Calendar buttons
            document.querySelectorAll('.google-calendar-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const course = {
                        title: this.getAttribute('data-title'),
                        days: this.getAttribute('data-days'),
                        time: this.getAttribute('data-time'),
                        endTime: this.getAttribute('data-end-time'),
                        location: this.getAttribute('data-location'),
                        instructor: this.getAttribute('data-instructor')
                    };
                    openSingleCourseInGoogleCalendar(course);
                });
            });
        }

        function downloadICS(courses) {
            try {
                let icsContent = 'BEGIN:VCALENDAR\n';
                icsContent += 'VERSION:2.0\n';
                icsContent += 'PRODID:-//Workday Converter//EN\n';
                icsContent += 'CALSCALE:GREGORIAN\n';
                icsContent += 'METHOD:PUBLISH\n';
                
                courses.forEach(course => {
                    const eventId = 'workday-event-' + course.id + '@workday-converter.com';
                    const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    
                    // Create a sample date (you might want to make this more sophisticated)
                    const sampleDate = new Date();
                    sampleDate.setDate(sampleDate.getDate() + 1); // Tomorrow
                    const dateStr = sampleDate.toISOString().split('T')[0].replace(/-/g, '');
                    
                    icsContent += 'BEGIN:VEVENT\n';
                    icsContent += 'UID:' + eventId + '\n';
                    icsContent += 'DTSTAMP:' + now + '\n';
                    icsContent += 'DTSTART:' + dateStr + 'T' + formatTimeForICS(course.time) + '\n';
                    icsContent += 'DTEND:' + dateStr + 'T' + formatTimeForICS(course.endTime) + '\n';
                    icsContent += 'SUMMARY:' + escapeICS(course.title) + '\n';
                    icsContent += 'RRULE:FREQ=WEEKLY;BYDAY=' + getRRuleDays(course.days) + '\n';
                    
                    if (course.location) {
                        icsContent += 'LOCATION:' + escapeICS(course.location) + '\n';
                    }
                    
                    if (course.instructor) {
                        icsContent += 'DESCRIPTION:Instructor: ' + escapeICS(course.instructor) + '\n';
                    }
                    
                    icsContent += 'END:VEVENT\n';
                });
                
                icsContent += 'END:VCALENDAR';
                
                // Download the file
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'workday-schedule.ics';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showSuccess('Calendar file downloaded successfully!');
                
            } catch (error) {
                showError('Error generating calendar file: ' + error.message);
            }
        }

        function formatTimeForICS(timeStr) {
            // Convert time like "09:00" or "9:00 AM" to "090000"
            let time = timeStr.toString().trim();
            
            // Handle AM/PM
            const isPM = time.toLowerCase().includes('pm');
            const isAM = time.toLowerCase().includes('am');
            
            // Remove AM/PM and extract numbers
            time = time.replace(/[^\d:]/g, '');
            const [hours, minutes] = time.split(':');
            
            let hour24 = parseInt(hours) || 9;
            if (isPM && hour24 < 12) hour24 += 12;
            if (isAM && hour24 === 12) hour24 = 0;
            
            return String(hour24).padStart(2, '0') + 
                   String(minutes || 0).padStart(2, '0') + '00';
        }

        function getRRuleDays(daysStr) {
            const dayMap = {
                'monday': 'MO', 'tuesday': 'TU', 'wednesday': 'WE', 'thursday': 'TH',
                'friday': 'FR', 'saturday': 'SA', 'sunday': 'SU',
                'mon': 'MO', 'tue': 'TU', 'wed': 'WE', 'thu': 'TH',
                'fri': 'FR', 'sat': 'SA', 'sun': 'SU'
            };
            
            const days = daysStr.toLowerCase().split(/[,\s]+/).filter(d => d);
            return days.map(day => dayMap[day] || 'MO').join(',');
        }

        function escapeICS(text) {
            return text.toString()
                .replace(/\\/g, '\\\\')
                .replace(/;/g, '\\;')
                .replace(/,/g, '\\,')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function openGoogleCalendar(courses) {
            if (courses.length === 0) {
                showError('No courses to add to calendar');
                return;
            }

            // Open the first course in Google Calendar
            const firstCourse = courses[0];
            const googleCalendarUrl = createGoogleCalendarUrl(firstCourse);
            
            // Open Google Calendar in a new tab
            window.open(googleCalendarUrl, '_blank');
            
            showSuccess(`Opened Google Calendar with "${firstCourse.title}". Use the individual "Add to Google Calendar" buttons in the table below to add each course.`);
        }

        function openSingleCourseInGoogleCalendar(course) {
            const googleCalendarUrl = createGoogleCalendarUrl(course);
            window.open(googleCalendarUrl, '_blank');
        }

        function createMultiCourseGoogleCalendarUrl(courses) {
            // For multiple courses, we'll create a URL that opens the first course
            // and provide instructions for the rest
            if (courses.length === 0) return '';
            
            const firstCourse = courses[0];
            const baseUrl = 'https://calendar.google.com/calendar/render';
            const params = new URLSearchParams();
            
            // Event title
            params.append('action', 'TEMPLATE');
            params.append('text', firstCourse.title);
            
            // Event description with all courses listed
            let description = `Course: ${firstCourse.title}`;
            if (firstCourse.instructor) {
                description += `\nInstructor: ${firstCourse.instructor}`;
            }
            if (firstCourse.location) {
                description += `\nLocation: ${firstCourse.location}`;
            }
            
            // Add list of all courses
            if (courses.length > 1) {
                description += `\n\nAll ${courses.length} courses from your Workday schedule:`;
                courses.forEach((course, index) => {
                    description += `\n${index + 1}. ${course.title}`;
                    if (course.days && course.time) {
                        description += ` (${course.days} ${course.time})`;
                    }
                    if (course.location) {
                        description += ` - ${course.location}`;
                    }
                });
                description += `\n\nNote: You'll need to add each course individually. Use the "Add to Calendar" button for each course.`;
            }
            
            params.append('details', description);
            
            // Location
            if (firstCourse.location) {
                params.append('location', firstCourse.location);
            }
            
            // For now, we'll create a sample date (you might want to make this more sophisticated)
            const sampleDate = new Date();
            sampleDate.setDate(sampleDate.getDate() + 1); // Tomorrow
            const dateStr = sampleDate.toISOString().split('T')[0].replace(/-/g, '');
            
            // Parse time (assuming format like "5:30 PM")
            const startTime = parseTimeForGoogleCalendar(firstCourse.time);
            const endTime = parseTimeForGoogleCalendar(firstCourse.endTime);
            
            // Create datetime strings
            const startDateTime = `${dateStr}T${startTime}`;
            const endDateTime = `${dateStr}T${endTime}`;
            
            params.append('dates', `${startDateTime}/${endDateTime}`);
            
            // Recurrence (simplified - weekly on the specified day)
            const recurrence = getRecurrenceRule(firstCourse.days);
            if (recurrence) {
                params.append('recur', recurrence);
            }
            
            return `${baseUrl}?${params.toString()}`;
        }

        function createGoogleCalendarUrl(course) {
            // Create a Google Calendar URL with pre-filled event details
            const baseUrl = 'https://calendar.google.com/calendar/render';
            const params = new URLSearchParams();
            
            // Event title
            params.append('action', 'TEMPLATE');
            params.append('text', course.title);
            
            // Event description
            let description = `Course: ${course.title}`;
            if (course.instructor) {
                description += `\nInstructor: ${course.instructor}`;
            }
            if (course.location) {
                description += `\nLocation: ${course.location}`;
            }
            params.append('details', description);
            
            // Location
            if (course.location) {
                params.append('location', course.location);
            }
            
            // For now, we'll create a sample date (you might want to make this more sophisticated)
            const sampleDate = new Date();
            sampleDate.setDate(sampleDate.getDate() + 1); // Tomorrow
            const dateStr = sampleDate.toISOString().split('T')[0].replace(/-/g, '');
            
            // Parse time (assuming format like "5:30 PM")
            const startTime = parseTimeForGoogleCalendar(course.time);
            const endTime = parseTimeForGoogleCalendar(course.endTime);
            
            // Create datetime strings
            const startDateTime = `${dateStr}T${startTime}`;
            const endDateTime = `${dateStr}T${endTime}`;
            
            params.append('dates', `${startDateTime}/${endDateTime}`);
            
            // Recurrence (simplified - weekly on the specified day)
            const recurrence = getRecurrenceRule(course.days);
            if (recurrence) {
                params.append('recur', recurrence);
            }
            
            return `${baseUrl}?${params.toString()}`;
        }

        function parseTimeForGoogleCalendar(timeStr) {
            // Convert time like "5:30 PM" to "173000" (24-hour format)
            let time = timeStr.toString().trim();
            
            // Handle AM/PM
            const isPM = time.toLowerCase().includes('pm');
            const isAM = time.toLowerCase().includes('am');
            
            // Remove AM/PM and extract numbers
            time = time.replace(/[^\d:]/g, '');
            const [hours, minutes] = time.split(':');
            
            let hour24 = parseInt(hours) || 9;
            if (isPM && hour24 < 12) hour24 += 12;
            if (isAM && hour24 === 12) hour24 = 0;
            
            return String(hour24).padStart(2, '0') + 
                   String(minutes || 0).padStart(2, '0') + '00';
        }

        function getRecurrenceRule(daysStr) {
            // Convert days to Google Calendar recurrence format
            const dayMap = {
                'monday': 'MO', 'tuesday': 'TU', 'wednesday': 'WE', 'thursday': 'TH',
                'friday': 'FR', 'saturday': 'SA', 'sunday': 'SU',
                'mon': 'MO', 'tue': 'TU', 'wed': 'WE', 'thu': 'TH',
                'fri': 'FR', 'sat': 'SA', 'sun': 'SU'
            };
            
            const days = daysStr.toLowerCase().split(/[,\s\/]+/).filter(d => d);
            const googleDays = days.map(day => dayMap[day] || 'MO').join(',');
            
            return `RRULE:FREQ=WEEKLY;BYDAY=${googleDays}`;
        }

        function resetConverter() {
            courses = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('preview').innerHTML = '';
            hideMessages();
        }
    </script>
</body>
</html>
